# 変更提案: consolidate-log-metrics

## 背景

`run` の snapshot と `tail` の bytes メトリクスは、`src/run.rs` と `src/tail.rs` にそれぞれ実装されています。現在の実装は同じ意味の値を算出している一方で、観測サイズや含有サイズの算出経路が別々に存在し、将来的な改修で差分が生まれるリスクがあります。

## 目的

- `run`/`tail` の bytes メトリクス算出を共通化し、仕様どおりの一貫性を保つ
- 振る舞い・JSON 形状・既存テストの期待値は変更しない

## スコープ

- `stdout_tail`/`stderr_tail` の抽出と `*_observed_bytes`/`*_included_bytes` の算出を共有ヘルパーに集約
- `run` の snapshot 生成と `tail` の JSON 生成を新ヘルパー経由に置換

## スコープ外

- ログ出力形式の変更（`full.log` の行形式など）
- `run` の待機ロジックやプロセス監視の再設計
- 既存 JSON スキーマの追加・削除

## 期待される効果

- メトリクス算出の一貫性が保証され、改修時のバグ混入を防止
- 仕様上の同義概念が単一の実装に集約され、保守性が向上

## リスクと対策

- 共有化の過程で既存の計算順序や取得時点が変わる可能性がある
  - 対策: 既存の取得タイミングを維持し、`run`/`tail` の各呼び出し位置は変更しない
